name: CI

on:
  workflow_dispatch:

jobs:
  changes:
    permissions:
      contents: read
      pull-requests: read
    runs-on: self-hosted-1cpu
    outputs:
      base: ${{ steps.filter.outputs.base }}
      go: ${{ steps.filter.outputs.go }}
      charts: ${{ steps.filter.outputs.charts }}
    steps:
      - name: Checkout
        uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b # v3.0.2

      - uses: dorny/paths-filter@b2feaf19c27470162a626bd6fa8438ae5b263721 # v2.10.2
        id: filter
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            base:
              - 'NGINX_BASE'
            go:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
              - 'rootfs/**/*'
              - 'TAG'
              - 'test/e2e/**/*'
            charts:
              - 'charts/ingress-nginx/Chart.yaml'
              - 'charts/ingress-nginx/**/*'

  build-base:
    name: Build base
    runs-on: self-hosted-8cpu
    needs:
      - changes
      - build
    if: |
      (needs.changes.outputs.base == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          version: latest
          use: false

      - name: Build
        run: |
          eval $(ssh-agent -s)
          echo "${{ secrets.GITLAB_DEPLOY_KEY }}" | tr -d '\r' | ssh-add -
          cd images/nginx && make OUTPUT=--load build
          docker save -o docker.tar $(cat NGINX_BASE)

  build-controller:
    name: Build controller
    runs-on: self-hosted-4cpu
    needs:
      - changes
      - build
      - build-base
#    if: |
#      (needs.changes.outputs.go == 'true' || needs.changes.outputs.base == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Go 1.19.1
        id: go
        uses: actions/setup-go@268d8c0ca0432bb2cf416faae41297df9d262d7f # v3.2.0
        with:
          go-version: '1.19.1'

      - name: Build image
        env:
          ARCH: amd64
          REGISTRY: wallarm
          TAG: 1.0.0-dev
          USER: runner
        run: |
          # If base was not changed
          export BASE_IMAGE="wallarm/ingress-nginx:$(cat TAG)"
          # TODO handle case when base image was changed
          # export BASE_IMAGE="wallarm/ingress-nginx:1.0.0-dev"
          set -x
          echo "Building controller"
          make clean-image build image
          docker images
          echo "Building E2E image"
          make -C test/e2e-image image
          docker images
          docker save -o docker.tar wallarm/ingress-controller:1.0.0-dev nginx-ingress-controller:e2e

      - name: Cache image
        uses: actions/upload-artifact@v3
        with:
          retention-days: 1
          name: docker.tar
          path: docker.tar


  smoke:
    name: Smoke
    runs-on: self-hosted-1cpu
    continue-on-error: true
    needs:
      - build-controller
    strategy:
      fail-fast: false
      matrix:
        k8s: [v1.23.10, v1.24.4, v1.25.0]
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Load cache
        uses: actions/download-artifact@v3
        with:
          name: docker.tar

      - name: Load images
        run: docker load -i docker.tar

      - name: Install helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.8.0'

      - name: Create cluster
        uses: helm/kind-action@v1.3.0
        with:
          version: v0.15.0
          cluster_name: kind
          node_image: kindest/node:${{ matrix.k8s }}

      - name: Run smoke tests
        env:
          # TODO remove SMOKE_IMAGE_TAG after testing!
          SMOKE_IMAGE_TAG: 0.0.9-rc1664274176
          ARCH: amd64
          KIND_CLUSTER_NAME: kind
          SKIP_CLUSTER_CREATION: true
          SKIP_IMAGE_CREATION: true
          WALLARM_API_TOKEN: ${{ secrets.WALLARM_API_TOKEN }}
          USER_UUID: ${{ secrets.WALLARM_API_USER_UUID }}
          USER_SECRET: ${{ secrets.WALLARM_API_USER_SECRET }}
          CLIENT_ID: 4
        run: |
          echo ${{ secrets.GITLAB_TOKEN_SECRET }} | docker login -u ${{ secrets.GITLAB_TOKEN_NAME }} --password-stdin dkr.wallarm.com
          kind get kubeconfig > $HOME/.kube/kind-config-kind
          export KUBECONFIG=$HOME/.kube/kind-config-kind
          make kind-smoke-test


  helm:
    name: Helm
    runs-on: self-hosted-1cpu
    needs:
      - build-controller
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Load cache
        uses: actions/download-artifact@v3
        with:
          name: docker.tar

      - name: Load images
        run: docker load -i docker.tar

      - name: Install helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.8.0'

      - name: Create cluster
        uses: helm/kind-action@v1.3.0
        with:
          version: v0.15.0
          cluster_name: kind
          node_image: kindest/node:v1.24.4

      - name: Run E2E chart tests
        env:
          ARCH: amd64
          KIND_CLUSTER_NAME: kind
          SKIP_CLUSTER_CREATION: true
          SKIP_IMAGE_CREATION: true
          WALLARM_API_TOKEN: ${{ secrets.WALLARM_API_TOKEN }}
        run: |
          kind get kubeconfig > $HOME/.kube/kind-config-kind
          export KUBECONFIG=$HOME/.kube/kind-config-kind
          make kind-e2e-chart-tests




  e2e:
    name: E2E - Wallarm disabled
    runs-on: self-hosted-4cpu
    needs:
      - build-controller
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Load cache
        uses: actions/download-artifact@v3
        with:
          name: docker.tar

      - name: Load images
        run: docker load -i docker.tar

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.8.0'

      - name: Create cluster
        uses: helm/kind-action@v1.3.0
        with:
          verbosity: "0"
          wait: "240s"
          version: v0.15.0
          node_image: kindest/node:v1.24.4
          config: test/e2e/kind.yaml
          cluster_name: kind

      - name: Run e2e tests
        env:
          KIND_CLUSTER_NAME: kind
          SKIP_CLUSTER_CREATION: true
          SKIP_IMAGE_CREATION: true
          ARCH: amd64
        run: |
          kind get kubeconfig > $HOME/.kube/kind-config-kind
          make E2E_NODES=10 kind-e2e-test




  e2e-wallarm-enabled:
    name: E2E - Wallarm enabled
    runs-on: self-hosted-4cpu
    needs:
      - build-controller
    strategy:
      matrix:
        k8s: [ v1.23.10, v1.24.4, v1.25.0 ]
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Load cache
        uses: actions/download-artifact@v3
        with:
          name: docker.tar

      - name: Load images
        run: docker load -i docker.tar

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.8.0'

      - name: Create cluster ${{ matrix.k8s }}
        uses: helm/kind-action@v1.3.0
        with:
          verbosity: "0"
          wait: "240s"
          version: v0.15.0
          node_image: kindest/node:${{ matrix.k8s }}
          config: test/e2e/kind.yaml
          cluster_name: kind

      - name: Run e2e tests
        env:
          ARCH: amd64
          KIND_CLUSTER_NAME: kind
          SKIP_CLUSTER_CREATION: true
          SKIP_IMAGE_CREATION: true
          WALLARM_ENABLED: true
          WALLARM_API_TOKEN: ${{ secrets.WALLARM_API_TOKEN }}
        run: |
          kind get kubeconfig > $HOME/.kube/kind-config-kind
          make E2E_NODES=10 kind-e2e-test
